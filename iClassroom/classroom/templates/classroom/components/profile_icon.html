{% load static %}
<link rel="stylesheet" href="{% static 'classroom/css/avatar_modal.css' %}">

<!-- Modal -->
<div class="modal-backdrop" id="avatarModal">
  <div class="avatar-modal">
    <div class="modal-header">
      <h3>Profile Picture</h3>
      <button class="modal-close" onclick="closeAvatarModal()">Ã—</button>
    </div>
    <div class="modal-content">
      <div class="avatar-preview-section">
        <div class="avatar-preview" id="avatarPreview">
          {% if user.avatar_url %}
            <img src="{{ user.avatar_url }}" alt="Profile Picture">
          {% else %}
            <span class="avatar-initial-preview">
              {{ user.first_name.0|default:"U" }}{{ user.last_name.0|default:"" }}
            </span>
          {% endif %}
        </div>
      </div>

      <div class="avatar-actions">
        <input type="file" id="avatarInput" accept="image/*" style="display:none">
        <button class="upload-btn" onclick="document.getElementById('avatarInput').click()">
          Upload New Photo
        </button>
        <button class="remove-btn" onclick="removeAvatar()" {% if not user.avatar_url %}style="display:none"{% endif %}>
          Remove Photo
        </button>
      </div>

      <div class="upload-info">
        <p>Supported formats: JPG, PNG, GIF</p>
        <p>Maximum file size: 5MB</p>
      </div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <p>Uploading...</p>
</div>

<script>
function openAvatarModal() {
  const modal = document.getElementById('avatarModal');
  modal.classList.add('active');
}

function closeAvatarModal() {
  const modal = document.getElementById('avatarModal');
  modal.classList.remove('active');
}

function showLoading() {
  document.getElementById('loadingOverlay').style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function () {
  const avatarInput = document.getElementById('avatarInput');

  avatarInput.addEventListener('change', function () {
    const file = avatarInput.files[0];
    if (!file) return;

    if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
      alert("Invalid file format. Please upload JPG, PNG, or GIF.");
      return;
    }

    if (file.size > 5 * 1024 * 1024) {
      alert("File too large. Max 5MB allowed.");
      return;
    }

    // Show loading spinner
    showLoading();

    // Upload using a form (POST to backend)
    const formData = new FormData();
    formData.append('avatar', file);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');  // Required if using Django CSRF

    fetch("{% url 'upload_avatar' %}", {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (!response.ok) throw new Error("Upload failed");
      return response.json();
    })
    .then(data => {
      hideLoading();
      if (data.success && data.avatar_url) {
        document.getElementById('avatarPreview').innerHTML = `<img src="${data.avatar_url}" alt="Profile Picture">`;
        document.querySelector('.remove-btn').style.display = 'block';
      } else {
        alert(data.error || "Failed to upload image.");
      }
    })
    .catch(error => {
      console.error(error);
      hideLoading();
      alert("Error uploading image.");
    });
  });
});

function removeAvatar() {
  if (!confirm("Are you sure you want to remove your profile picture?")) return;

  showLoading();

  fetch("{% url 'remove_avatar' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => {
    if (!response.ok) throw new Error("Failed to remove");
    return response.json();
  })
  .then(data => {
    hideLoading();
    if (data.success) {
      const initials = '{{ user.first_name.0|default:"U" }}{{ user.last_name.0|default:"" }}';
      document.getElementById('avatarPreview').innerHTML = `<span class="avatar-initial-preview">${initials}</span>`;
      document.querySelector('.remove-btn').style.display = 'none';
    } else {
      alert(data.error || "Failed to remove photo.");
    }
  })
  .catch(error => {
    console.error(error);
    hideLoading();
    alert("Error removing avatar.");
  });
}
</script>
